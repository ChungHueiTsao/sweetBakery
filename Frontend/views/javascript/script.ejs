<script>
  $(document).ready(function () {

    /** reload page **/
    var perfEntries = performance.getEntriesByType("navigation");

    if (perfEntries[0].type === "back_forward") {
      location.reload(true);
    }

    /** increment/decrement **/
    var remain = parseInt($(".remain").text())

    $(".plus").on("click", function () {

      var inputNum = $(".inputNum");
      var value = $(".inputNum").val();
      value++;
      inputNum.val(value);
      console.log(value)

      if (value > remain) {
        $(".errorMsg").css("visibility", "visible");
        $(".signUpBtn").prop("disabled", true);
      } else {
        $(".errorMsg").css("visibility", "hidden");
        $(".signUpBtn").prop("disabled", false);
      }

    })

    $(".inputNum").on("keyup", function () {
      var value = $(".inputNum").val();

      if (value > remain) {
        $(".errorMsg").css("visibility", "visible");
        $(".signUpBtn").prop("disabled", true);
      } else {
        $(".errorMsg").css("visibility", "hidden");
        $(".signUpBtn").prop("disabled", false);
      }

    })

    $(".minus").on("click", function () {

      var inputNum = $(".inputNum");
      var value = $(".inputNum").val();

      if (value > 1) {
        --value;
        inputNum.val(value);
      }
      console.log(value)

      if (value <= remain) {
        $(".errorMsg").css("visibility", "hidden");
        $(".signUpBtn").prop("disabled", false)
      } else {
        $(".errorMsg").css("visibility", "visible");
        $(".signUpBtn").prop("disabled", true)
      }
    })

    $(".signUpBtn").on("click", function () {
      var value = $(".inputNum").val();
      sessionStorage.setItem("guestKey", value)
      var data = sessionStorage.getItem("guestKey")
      console.log(`session storage ${data}`)
    })


    //open product modal when click on product cart
    $(".fa-shopping-cart").on("click", () => {
      $(".modal-container").show()
    })

    //close product modal when click on X
    $(".closeModal").on("click", function () {
      $(".modal-container").hide()
    })


    //toggle burger menu on click
    $(".burgerMenu").on("click", function (e) {
      $(".nav-items").toggleClass("active")
    })

    $(window).resize(function () {
      if ($(".nav-items").hasClass("active")) {
        $(".nav-items").removeClass("active");
      }
    })

    //Sign in and sign up events
    $("#signUp").on("click", () => {
      $(".container").addClass("right-panel-active")
      console.log("signup")
    })

    $("#signIn").on("click", () => {
      $(".container").removeClass("right-panel-active")
      console.log("signin")
    })

    $(".userIcon").on("click", function () {
      $(".loginModal").show()
    })

    //Close login/forget pw modal event
    $(".closeModal").on("click", function () {
      $(".loginModal").hide()
      $(".forgetPwModal").hide()
    })

    //click forgetpwbtn to open modal
    $(".forgetPwBtn").on("click", function () {
      $(".loginModal").hide()
      $(".forgetPwModal").show()
    })

    //click loginbtn to open modal
    $(".loginBtn").on("click", function () {
      $(".forgetPwModal").hide()
      $(".loginModal").show()
    })

    //close login modal when click outside
    $(".modal-overlay").on("click", function () {
      $(".loginModal").hide()
    })

    // toggle search input field
    $(".searchBtn").on("click", function () {
      // $(".search-input").toggleClass("active")
      console.log("ok")
    })


    /* Product Search Function */
    var productTitleArray = [];

    //refresh productTitleLength
    function refreshproductTitleLength() {
      productTitleArray = [];
      var productTitleLength = $('.productTitle').length;
      for (i = 0; i < productTitleLength; i++) {
        productTitleArray.push({ name: $('.productTitle:eq(' + i + ')').text() });
      }
    }

    refreshproductTitleLength();


    // keyDown search btn  
    $(".searchBtn").on("click", function (e) {
      $(".search-input").toggleClass("active");
      $(`.productTitle`).parents(".productCard").css("display", "none");
      var val = $.trim($('.search-input').val()); //copy search inputContent    "trim" > remove space 
      if (val) {
        val = val.toLowerCase();
        console.log("val: " + val)
        $.each(productTitleArray, function (_, item) {
          if (item.name.toLowerCase().indexOf(val) != -1) {
            $(`.productTitle:contains('${val}')`).parents(".productCard").css("display", "");
          }
        });
      } else {
        $(`.productTitle`).parents(".productCard").css("display", "");
      }
      // refresh again
      refreshproductTitleLength();
    })


    //change images when click on thumbnail
    for (var i = 0; i < $(".thumbnail").length; i++) {
      $(".thumbnail").on("click", function () {
        if ($(".active").length > 0) {
          $(".active").removeClass("active")
        }
        $(this).addClass("active")
        $("#featured").attr("src", $(this).attr("src"))
      })
    }

    //會員資訊
    var userCurrentName;
    var userCurrentEmail;;
    var userCurrentPhone;
    var userCurrentBirthday;


    // 會員註冊
    $('#signupBtn').on('click', function () {
      console.log('ok');
      let registerName = $("input[ name = memberRegisterName]").val();
      let registerEmail = $("input[ name = memberRegisterEmail]").val();
      let registerPassword = $("input[ name = memberRegisterPassword]").val();
      let registerPhone = $("input[ name = memberRegisterPhone]").val();
      let registerBirthday = $("input[ name = memberRegisterBirthday]").val();
      $.ajax({
        url : "/login/memberRegister",
        data : {
          name : registerName,
          email : registerEmail,
          password : registerPassword,
          phone : registerPhone,
          birthday : registerBirthday
        },
          type : "post",
          success: function (jsonData) {
            switch (jsonData.data) {
            case 0: //帳號不存在
              Swal.fire({
                position: 'top',
                icon: 'info',
                title: '帳號已存在，請登入',
                showConfirmButton: false,
                timer: 1700
              });
              break;
            case 1: //密碼錯誤
              Swal.fire({
                position: 'top',
                icon: 'warning',
                title: '密碼錯誤，請再次輸入',
                showConfirmButton: false,
                timer: 1700
              });
              break;
            case 2: //登入成功
              Swal.fire({
                position: 'top',
                icon: 'success',
                title: '帳號登入成功',
                showConfirmButton: false,
                timer: 1700
              })
              setTimeout(() => {
                window.location.href = "/user";
                console.log(jsonData.user.email);
                $('#userName').val(jsonData.user.email);
              }, 2000);
              break;
            default:
              console.log("狀態錯誤");
              break;
          }
          } 
        })
    })

    //會員登入
    $('#loginBtn').on('click', function () {
      let loginEmail = $("input[ name= memberLoginEmail ]").val();
      let loginPassword = $("input[ name = memberLoginPassword ]").val();
      $.ajax({
        url: "/login/memberLogin",
        data: { email: loginEmail, password: loginPassword },
        type: "post",
        success: function (jsonData) {
          console.log(jsonData.user);
          console.log(jsonData.data);
          switch (jsonData.data) {
            case 0: //帳號不存在
              Swal.fire({
                // position: 'top',
                icon: 'warning',
                title: '帳號不存在，請註冊帳號',
                showConfirmButton: false,
                timer: 1700
              });
              break;
            case 1: //密碼錯誤
              Swal.fire({
                // position: 'top',
                icon: 'error',
                title: '密碼錯誤，請再次輸入',
                showConfirmButton: false,
                timer: 1700
              });
              break;
            case 2: //登入成功
              Swal.fire({
                // position: 'top',
                icon: 'success',
                title: '帳號登入成功',
                showConfirmButton: false,
                timer: 1700
              })
              setTimeout(() => {
                window.location.href = "/user"; 
              }, 2000);
              $("input[ name= userName ]").append(jsonData.user.userName);
              $("input[ name= userMail ]").append(jsonData.user.email);
              $("input[ name= userPhone ]").append(jsonData.user.userPhone);
              $("input[ name= userBirthday ]").append(jsonData.user.userBirthday);
              // $('#userName').val(jsonData.user.email);
              break;
            default:
              console.log("狀態錯誤");
              break;
          }
        }
      })
    });
    //變更密碼
    $('#changePasswordBtn').on('click', function () {
      Swal.fire({
        position: 'top',
        icon: 'success',
        title: '密碼修改完成',
        showConfirmButton: false,
        timer: 1700
      });
    })

    // 會員資料變更
    $('#changeUserInfo').on('click', function () {
      Swal.fire({
        position: 'top',
        icon: 'success',
        title: '會員基本資料修改完成',
        showConfirmButton: false,
        timer: 1700
      });
    })
  })
</script>