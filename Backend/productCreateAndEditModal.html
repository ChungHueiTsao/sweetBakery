<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Create and Edit Modal</title>
    <link rel="stylesheet" href="./scss/style.css">
    <script src="./js/jquery-3.6.0.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js"></script>

</head>

<body>
    <p>
        還好沒了吧懶的一吉。間的遊戲，好像，的感覺應該是。最後一，麼不一期待的時候才發現。

        有這麼⋯肖時欽，星為起歡迎想要，看過我也餅很⋯到我所以也件事家職一我去？麼比起我最在的只是，不小啊啊啊，另外一落惡你會是小用畢竟是，看一次好了標註就是很給他，哪搬家準備覺的⋯一直道他應該⋯的過程團隊的好可月亮真的，國中的很想⋯是非的話那真的要，麼事，入因為抽的只能量事我前事。還沒到正常的開我還是，以吃好好看兩天⋯牌，是沒後他也要意思嗎中一個好像⋯自己有知所以這，然的笑在台北啦。
    </p>

    <div id="productCreateAndEditModal" class="bigModal">

        <div class="modalWrap">


            <span class="modalClose">&times;</span>

            <div class="modalContent">

                <p id="mainModalTitle">商品新增/編輯</p>

                <div class="bigModalForm">

                    <div id="uploadImg">
                        <div id="uploadArea">
                            <input hidden type="file" multiple id="fileUpload">
                            <div><label for="fileUpload">+</label></div>
                            <p>點擊或拖曳上傳</p>
                        </div>
                        <div id="showImgArea">

                            <!-- <div class="imgItem">
                                <div>&times;</div>
                                <div>
                                    <img src="./public/img/productDetailPic.jpg" alt="">
                                </div>
                            </div> -->


                        </div>
                    </div>

                    <div class="formField">

                        <div class="formGroup">
                            <label for="productTitle">商品名稱:</label>
                            <input id="productTitle" type="text">
                        </div>

                        <div class="formGroup">
                            <label for="categoryId">商品類別:</label>
                            <select id="categoryId">

                            </select>
                        </div>
                        <div class="formGroup">
                            <label for="sizeId">商品規格:</label>
                            <select id="sizeId">

                            </select>
                        </div>

                        <div class="formGroup">
                            <label for="productPrice">商品單價:</label>
                            <input id="productPrice" type="number" >
                        </div>

                        <div class="formGroup">
                            <label for="productStatus">商品狀態:</label>
                            <label class="toggleSwitch">
                                <input id="productStatus" type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="formGroup">
                            <label for="productInfo">商品簡介:</label><br>
                            <textarea id="productInfo" cols="40"></textarea>
                        </div>
                        <div class="formGroup">
                            <label for="ingredient">商品成份:</label><br>
                            <textarea id="ingredient" cols="40"></textarea>
                        </div>
                        <div class="formGroup">
                            <button id="sendProduct" type="button">確定</button>
                            <button type="button">取消</button>
                        </div>
                    </div>
                </div>


            </div>

        </div>

    </div>

    <script>
        $(document).ready(function () {
            // 取得新增編輯商品視窗的選項點增加商品button
            $.get('/productList/editOrAddOption', function (option) {
                // console.log(e[0][1]);
                let category = option[0];
                let size = option[1];
                category.map(value => {
                    // console.log(value)
                    $("#categoryId").append($('<option>')
                        .text(value.categoryName)
                        .val(value.categoryId));
                });
                size.map(value => {
                    // console.log(value)
                    $("#sizeId").append($('<option>')
                        .text(value.sizeName)
                        .val(value.sizeId));
                });

                // console.log(typeof option[0]);

            })
            //textarea根據內容自動調整高度
            $("textarea").on("input", function () {
                $(this).css('height', 'auto');
                var textareaHeight = $(this).prop('scrollHeight');
                $(this).css('height', `${textareaHeight}px`);

                var modalWrapHeight = $('.modalWrap').prop('scrollHeight');
                if (modalWrapHeight > 610) {
                    $('.modalWrap').css('overflow-y', 'scroll');
                };
            });
            // 顯示上傳的圖片
            function showUploadedImg() {
                $('.imgItem').remove();
                for (let i = 0; i < files.length; i++) {
                    var reader = new FileReader();
                    let file = files[i];
                    reader.onload = function (readFile) {
                        $("#showImgArea").append(`
                            <div class="imgItem"> 
                                <div class="deleteImg">&times;</div>
                                <div>
                                    <img src=${readFile.target.result}> 
                                    <label hidden>${file.name}</label>
                                </div>
                            </div>
                        `);
                    }
                    reader.readAsDataURL(file);

                }
            }
            let files = [];
            let productItem = {}

            // 上傳區
            $('#uploadArea').on('dragover', function (e) {
                e.preventDefault();
                // 檔案在上傳區上方加class樣式
            }).on('dragleave', function () {
                // 檔案離開上傳區上方移除class樣式
            }).on('drop', function (e) {
                e.preventDefault();
                // 檔案放在上傳區時移除樣式
                for (let i = 0; i < e.originalEvent.dataTransfer.files.length; i++) {
                    files.push(e.originalEvent.dataTransfer.files[i]);

                }
                showUploadedImg();
            });
            // 點+增加檔案
            $("#fileUpload").on('change', function (e) {
                for (let i = 0; i < e.target.files.length; i++) {
                    files.push(e.target.files[i]);

                }
                showUploadedImg();
            });
            // 按X刪除檔案
            $("#showImgArea").on('click', '.deleteImg', function () {
                let fileName = $(this).parent('div').find('label').text();
                files.map((value, index) => {

                    if (fileName == value.name) {
                        files.splice(index, 1);
                    }
                });
                showUploadedImg();
            });
            $("#sendProduct").on('click', function () {
                // 確定input都有輸入值，才能送出
                let productTitle = $("#productTitle").val();
                let categoryId = $('#categoryId').val();
                let sizeId = $('#sizeId').val();
                let productPrice = $('#productPrice').val();
                let productStatus = $('#productStatus').prop('checked');
                let productInfo = $('#productInfo').val();
                let ingredient = $('#ingredient').val();
                

                if (productTitle && productPrice && productInfo && ingredient && (files.length>0)) {

                    // 可送出資料
                    let formDataAdd = new FormData();
                    // 檔案加入formData中
                    files.forEach((value, index) => {

                        var fileName = files[index].name;
                        let dotPosition = fileName.lastIndexOf('.');
                        let fileType = fileName.substr(dotPosition);
                        // formDataAdd.append('files', value, `${index + 1}${fileType}`);
                        formDataAdd.append('files', value);

                    });
                    if (productStatus) {
                        productStatus = '上架中'
                    } else {
                        productStatus = '下架';
                    }
                    formDataAdd.append('productTitle', productTitle);
                    formDataAdd.append('categoryId', categoryId);
                    formDataAdd.append('sizeId', sizeId);
                    formDataAdd.append('productPrice', productPrice);
                    formDataAdd.append('productStatus', productStatus);
                    formDataAdd.append('productInfo', productInfo);
                    formDataAdd.append('ingredient', ingredient);
                    $.ajax({
                        url: '/productList/addProduct',
                        type: 'post',
                        data: formDataAdd,
                        processData: false,
                        contentType: false,
                        dataType: "json",
                        success: function (data) {
                            console.log(data);
                            // 清空存放陣列的檔案
                            files=[];
                        }
                    });
                } else {
                    alert('輸入框內容不可空白');
                }

            });
           
        });
    </script>

            
</body>

</html>